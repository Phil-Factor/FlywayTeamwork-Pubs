# FlywayTeamwork
###  Powershell-based Database Development with Branches using Flyway

This is a sample  Flyway framework for supporting  database development with Flyway. It currently supports  PostgreSQL, SQL Server, MySQL, MariaDB and SQLite. If you clone it, you will have a playground for trying Flyway out. 

This framework is designed to make it easier to use PowerShell scripts and callbacks of various kinds. This project has gradually evolved to support an expanding series of articles all about Flyway.  It  uses for its examples the old Pubs database, originally a demo database from Sybase. The whole purpose is  to demonstrate and explore the features of Flyway. However, it should be very useful for anyone starting out to develop scripts for use with Flyway because it is otherwise hard to get over the initial culture-shock. In this version called FlywayTeamwork, we’ve expanded the system to make it suitable for enterprise-scale developments,  diversified its support for a range of relational databases and rearranged the directory structure to a hierarchical one to accommodate the practice of branching. Although designed with GIT in mind, and currently used with GIT, it is designed to be able to work with any reasonable source control system. It does not rely on the source control system to accomodate branching- it can do it intrinsically.  It is better not to use Git’s branching mechanism which does not work naturally with databases rather then compiled code. 

We’re using the following model of branching. 

![FlywayHierarchy](https://user-images.githubusercontent.com/917048/152835501-ddc5c01a-c707-45b3-b5d3-e4e20efb8108.png)

Within each branch is held all the migrations, scripts, models and reports. Each branch therefore has the same  names and purpose for its subdirectories. The sub-branches of any branch are contained in a ‘branches’ directory. 

This system is geared to using file links so that the source, configuration and so on is all held in just one place and replicated via links. This isn’t essential and it will work even of code is duplicated. 

We’ve also used the Current Working Directory or ’current location’. This means that the PowerShell must make the branch being worked on the current working directory $pwd. (think CD or Set-Location).  This allows all the server and database connection details to be kept in the branch folder.  It also means that a user can switch between branches merely by changing location/$pwd. The password is either stored or retrieved from the user area as a secure string, and is located by Server, User_ID and RDBMS (it is possible to have two different REDBMS on the same server)  The user-based Flyway.Conf file will need to store the user name (the ‘*installedBy*’  parameter) if you need to change this, you can over-ride the default identity with a command-line parameter or an environment variable. 

Another change is to allow several database project in the one project collection.  This has been flagged up as a potential problem by teams wanting to use Flyway.  Each database is in a directory whose name is the name of the project. This allows us to store all scripts, modules  and  routines that are to be used universally within the same project to be in just one place. This avoids a potential maintenance nightmare as these need updating.

All this requires that every PowerShell script that does a flyway action has to have an initialisation so that all the scriptBlocks, functions, cmdlets and so on are read in, and the context of the PowerShell script can be worked out. It puts all the data that it gathers into a hashtable that is easily available to the script.

All the examples of scripts, migration scripts (used in the course of a migration), and callback scripts have been altered accordingly. By using an initialisation, it has been possible to standardise these. 

The current catalog of supported tasks is here in [The Flyway Teamworks Scriptblocks.](https://github.com/Phil-Factor/FlywayTeamwork-Pubs/blob/main/ScriptBlocks.md) The aim is to gradually make all the tasks multi-RDBMS as and when anybody wants that. If you don’t ask, I’m less enthusiastic

For an introduction to the framework, see [What is the Flyway Teamwork Framework?](https://www.red-gate.com/hub/product-learning/flyway/what-is-the-flyway-teamwork-framework?product=flyway) This will tell you the basics. After you’ve read that, there are plenty of other sources of information such as:

| The Flyway Article                                           | What it is about.                                            |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| [Reviewing SQL Migration Files Before a Flyway Migration](https://www.red-gate.com/hub/product-learning/flyway/reviewing-sql-migration-files-before-a-flyway-migration?product=flyway) | This article demonstrates how, once armed with the file path locations of all the scripts, you can use PowerShell to search them for various purposes such to review them for potentially disruptive changes, or run code quality checks, or to verify documentation standards. |
| [Try Before You Commit in Flyway](https://www.red-gate.com/hub/product-learning/flyway/try-before-you-commit-in-flyway?product=flyway) | Sometimes we want to check whether it is possible to run a Flyway migration without error, but not actually make the changes. We might just need to 'sanity test' the performance of a migration on the Staging server, for example. By using a placeholder 'switch' to trigger a SQL Exception, we can get Flyway to roll-back its transaction, and therefore the migration, on demand. |
| [Finding the Version of a Flyway-managed Database Using SQL](https://www.red-gate.com/hub/product-learning/flyway/finding-the-version-of-a-flyway-managed-database-using-sql?product=flyway) | Maintaining a version of a database opens a lot of possibilities, especially if an automated process can easily grab the current version, at runtime, using just SQL. You might, for example, have a routine that is only appropriate after a particular version. It is also very handy to be able to associate entries in an event log or bug report with the database version. |
| [Rollbacks, Undos and Undonts](https://www.red-gate.com/hub/product-learning/flyway/rollbacks-undos-and-undonts?product=flyway) | Rollback scripts are designed to allow us to recover safely from a failed deployment that leaves the database in an indeterminate state. They must check exactly what needs to be reverted before doing so. If you work with an RDBMS that cannot support transaction DDL rollback they are vital. This article proposes a strategy where you create and test a rollback file, at the same time as the forward migration, and reuse it as a Flyway undo script |
| [Managing Static Data in Flyway Database Development](https://www.red-gate.com/hub/product-learning/flyway/managing-static-data-in-flyway-database-development?product=flyway) | If your database application requires 'static data' to function, then the best way to manage that data is using a view based on a derived table. This article demonstrates ways to create these views, depending on your RDBMS's capabilities, and how to build and manage them in development work, using Flyway and PowerShell |
| [Managing Datasets for Database Development Work using Flyway](https://www.red-gate.com/hub/product-learning/flyway/managing-datasets-for-database-development-work-using-flyway?product=flyway) | A generic way of exporting, deleting and loading data, for database development work. It uses Flyway Teams, a PowerShell framework, JSON files for storage and a table manifest to define the correct order of dependency for each task. It should help a team maintain datasets between database versions, as well as to switch between the datasets required to support different types of testing. |
| [The Uses of Dependency Information in Database Development](https://www.red-gate.com/hub/product-learning/flyway/the-uses-of-dependency-information-in-database-development?product=flyway) | Dependency information will allow you to avoid errors during a database build or tear-down, by ensuring you create or remove objects in the right order. It will also help you to avoid future 'invalid object' errors, because it will allow you to check that no database alterations have introduced broken references, during Flyway migrations |
| [Performance Testing Databases with Flyway and PowerShell](https://www.red-gate.com/hub/product-learning/flyway/performance-testing-databases-with-flyway-and-powershell?product=flyway) | Performance tests are central to the quality of the database changes we deliver because they ensure that any business process that accesses the database continues to return its results in an acceptable time. When Flyway creates a new version of the database, it is the ideal time to run these performance checks |
| [Running Unit and Integration Tests during Flyway Migrations](https://www.red-gate.com/hub/product-learning/flyway/running-unit-and-integration-tests-during-flyway-migrations?product=flyway) | In this article I'll give a practical example of developing a database, with Flyway, in such a way that it is automatically tested with whatever unit tests and integration tests you specify whenever you migrate the branch you're working on to the next version. If a test fails, you can work out why, undo the migration and then try again |
| [Introduction to Testing a Flyway Development](https://www.red-gate.com/hub/product-learning/flyway/introduction-to-testing-a-flyway-development?product=flyway) | How to use Flyway Teams to run basic tests whenever it successfully executes a migration, checking that all the business processes supported by our database always produce the expected results. |
| [Re-baselining a Database using Flyway Desktop](https://www.red-gate.com/hub/product-learning/flyway/re-baselining-a-database-using-flyway-desktop?product=flyway) | Over time, Flyway projects can accumulate a lot of migration scripts, with many database objects being created, altered, and dropped across many files. Tonie Huizer explains why you might want to create a new baseline migration file to create the latest version of a Flyway-managed database in a single leap, and how to persuade Flyway Desktop to do it |
| [Searching a Flyway Database](https://www.red-gate.com/hub/product-learning/flyway/searching-a-flyway-database?product=flyway) | As a database gets larger, and development more complex, so it becomes increasingly necessary to be able to search for strings in the source files and the database itself. Maybe you need to find when a table first got created, when a foreign key was added, or to find out which tables lack documentation. I'll show you how to answer these sorts of questions by running simple 'wildcard' searches on your Flyway migration files, or source files, as well as more targeted searches on certain parts of your database model |
| [Building a Database with Flyway](https://www.red-gate.com/hub/product-learning/flyway/building-a-database-with-flyway?product=flyway) | Flyway, especially Flyway Teams edition, can be used in several different ways to accommodate a database development that was originally based on builds rather than migrations. This article explores four different ways to use Flyway to build a particular version of a database, from the ground up, using a single migration script. It should help teams select the best way to incorporate Flyway into an existing database build system, during development, while benefitting from use of Flyway's versioned migration system for deployments and releases. |
| [Increasing the Visibility of Database Changes in Flyway Development](https://www.red-gate.com/hub/product-learning/flyway/increasing-the-visibility-of-database-changes-in-flyway-development?product=flyway) | If you save a metadata 'model' for every new version of a database created by Flyway, you can compare the current model to the previous one to see what changed. In turn, you can then generate a database E-R diagram that highlights the changed objects, instantly making those changes visible to other team members |
| [DevOps Collaboration and Process Visibility in Flyway Developments](https://www.red-gate.com/hub/product-learning/flyway/devops-collaboration-and-process-visibility-in-flyway-developments?product=flyway) | A brief history of the DevOps movement and a discussion of the pivotal role of a tool like Flyway in the DevOps toolchain, when developing and delivering database changes |
| [Taming Database Documentation with Flyway and MySQL](https://www.red-gate.com/hub/product-learning/flyway/taming-database-documentation-with-flyway-and-mysql?product=flyway) | Database object documentation is essential for explaining to busy developers, and the wider business, the purpose of each object and how to use it. The solution presented in this article consists of a SQL script to allow developers to add comments to MySQL database objects, without affecting the database version, and a simple way to generate a documentation report, in JSON. The SQL script will execute automatically as a callback, during any Flyway Teams migration run, and the report will allow the team to spot any gaps quickly |
| [Cross-RDBMS Version Checks in Flyway](https://www.red-gate.com/hub/product-learning/flyway/cross-rdbms-version-checks-in-flyway?product=flyway) | How does one check that a database is definitively at the version that Flyway says it is? Or that a test teardown procedure leaves no trace in the database? Or verify that an undo script returns a database's metadata to that state it should be in for the version to which you're rolling back? This article shows how to do high-level version checks, by comparing JSON models. |
| [Automating Flyway Development Chores using Database Diagrams](https://www.red-gate.com/hub/product-learning/flyway/automating-flyway-development-chores-using-database-diagrams?product=flyway) | If you can produce a quick Entity-Relationship diagram for any version of a database, you'll have a simple way to 'sanity check' it for unreferenced tables, missing keys and other design flaws. This article shows how to auto-generate these diagrams when running a migration, using Flyway Teams and PowerShell |
| [Database Testing in a Flyway Development](https://www.red-gate.com/hub/product-learning/flyway/database-testing-in-a-flyway-development?product=flyway) | If you can test and evaluate databases, and database objects, at every phase of the database development lifecycle, then you are much more likely to be able to adopt continuous delivery. The further down the delivery pipeline that bugs appear, the more costly in time and resources they are to fix |
| [Managing Database Code Quality in a Flyway Development](https://www.red-gate.com/hub/product-learning/flyway/managing-database-code-quality-in-a-flyway-development?product=flyway) | In this article, I'll discuss the most important quality metrics for a database development, and then practical ways to ensure that a Flyway-managed database is designed and implemented to a high enough standard that it is reliable to use |
| [Getting Started with Flyway and any RDBMS](https://www.red-gate.com/hub/product-learning/flyway/getting-started-with-flyway-and-any-rdbms?product=flyway) | How to get started with Flyway, as simply as possible, using PowerShell. This article provides a practice set of Flyway migration scripts that will build the original pubs database on either SQL Server, PostgreSQL, MySQL, MariaDB or SQLite and then migrate it from version to version, making a series of improvements to its schema design |
| [Simple Reporting with Flyway and Database Models](https://www.red-gate.com/hub/product-learning/flyway/simple-reporting-with-flyway-and-database-models?product=flyway) | If you can generate a file-based (JSON) model for each new version of a database, produced by a Flyway migration, then you have an easy way to run simple reports to help you search, list, and understand the structure of these databases. I'll show how to produce the models using PowerShell and then run some queries against them to generate the reports |
| [Flyway and Simple Source Control](https://www.red-gate.com/hub/product-learning/flyway/flyway-and-simple-source-control?product=flyway) | How to integrate Flyway database development with Source control, so that you can track what changes were made and who made them as well as which objects changed between versions, and how |
| [Flyway How-tos: a User’s Perspective](https://www.red-gate.com/hub/product-learning/flyway/flyway-how-tos-a-users-perspective?product=flyway) | Flyway provides a database-independent way for a team to track, manage and apply database changes, while maintaining strict control of database versions. It updates a database by running a series of versioned migration scripts, in order, and keeps track of all the changes in a special "schema history" table. It sounds simple, but it is easy to derail this team discipline if you don't find the right answers to the following questions |
| [Database Development Visibility using Flyway and PowerShell](https://www.red-gate.com/hub/product-learning/flyway/database-development-visibility-using-flyway-and-powershell?product=flyway) | The payback of DevOps is not simply in automation but in using that automation to increase the visibility of the development processes. This article demonstrates way to make Flyway developments more visible, regardless of your RDBMS, such as by providing a detailed migration history, and change reports that reveal detail of what is going on to all involved. |
| [Creating Flyway Migration Files using Redgate Schema Comparison Tools](https://www.red-gate.com/hub/product-learning/flyway/creating-flyway-migration-files-using-redgate-schema-comparison-tools?product=flyway) | How to use Redgate's schema comparison engines to generate object-level scripts for every database version that Flyway creates, and then use them to create ad-hoc, Flyway-compatible migration files. |
| [Getting an Overview of Changes to a PostgreSQL Database using Flyway](https://www.red-gate.com/hub/product-learning/flyway/getting-an-overview-of-changes-to-a-postgresql-database-using-flyway?product=flyway) | How to use Flyway and PowerShell to automatically generate a database build script every time Flyway successfully created a new version. You can then investigate schema changes between versions simply by using a Diff tool to compare build scripts. |
| [Dealing with Database Data and Metadata in Flyway Developments](https://www.red-gate.com/hub/product-learning/flyway/dealing-with-database-data-and-metadata-in-flyway-developments?product=flyway) | Before you get very far with database development you need to be clear about your strategy for handling data. In this article I'll explain some of these issues in general terms, and then demonstrate how you can navigate these problems easily with Flyway |
| [Flyway Gotchas](https://www.red-gate.com/hub/product-learning/flyway/flyway-gotchas?product=flyway) | Explaining some of the 'gotchas' that can trip up the unwary Flyway user, and how to avoid them. One or two of these you'll encounter quickly, such as the case-sensitivity of parameters and arguments. Others, such as potential problems with undo scripts or running scripted callbacks, only when you are tackling more complex development processes |



There are plenty more articles about Flyway Teamworks here https://www.red-gate.com/hub/product-learning/flyway

